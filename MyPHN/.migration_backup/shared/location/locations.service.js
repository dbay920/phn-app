"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var fetchModule = require("fetch");
var xmlModule = require("tns-core-modules/xml");
var location_1 = require("./location");
var county_1 = require("./county");
var detail_1 = require("./detail");
var provider_1 = require("../providers/provider");
var currentLocation;
var currentLocations;
var currentCounties;
var currentCounty;
var currentDetail;
var onEventCallback2 = function (event) {
    switch (event.eventType) {
        case xmlModule.ParserEventType.StartElement:
            if (event.elementName !== 'a')
                break;
            currentCounty = new county_1.County();
            currentCounties.push(currentCounty);
            var message = event.eventType + " " + event.elementName;
            if (event.attributes) {
                message += ", Attributes:";
                for (var attributeName in event.attributes) {
                    if (event.attributes.hasOwnProperty(attributeName) && attributeName === 'href') {
                        message += " " + attributeName + "=\"" + event.attributes[attributeName] + "\"";
                        currentCounty.push(event.attributes['href']);
                    }
                }
            }
            //console.log(message);
            break;
        case xmlModule.ParserEventType.EndElement:
            //console.log(event.eventType + " " + event.elementName);
            break;
        case xmlModule.ParserEventType.Text:
            var significantText = event.data.trim();
            if (significantText !== "") {
                //console.log(event.eventType + "=\"" + significantText + "\"");
                //currentCounty.push(significantText);
            }
            break;
    }
};
var onEventCallback3 = function (event) {
    switch (event.eventType) {
        case xmlModule.ParserEventType.StartElement:
            if (event.elementName === 'img') {
                currentDetail.setImage(event.attributes['src']);
            }
            var message = event.eventType + " " + event.elementName;
            if (event.attributes) {
                message += ", Attributes:";
                for (var attributeName in event.attributes) {
                    if (event.attributes.hasOwnProperty(attributeName) && attributeName === 'href') {
                        message += " " + attributeName + "=\"" + event.attributes[attributeName] + "\"";
                    }
                }
            }
            //console.log(message);
            break;
        case xmlModule.ParserEventType.EndElement:
            //            console.log(event.eventType + " " + event.elementName);
            break;
        case xmlModule.ParserEventType.Text:
            var significantText = event.data.trim();
            if (significantText !== "") {
                //   console.log(event.eventType + "=\"" + significantText + "\"");
            }
            currentDetail.push(significantText);
            break;
    }
};
var onErrorCallback = function (error) {
    //console.log("Error: " + error.message);
};
var countyParser = new xmlModule.XmlParser(onEventCallback2, onErrorCallback);
var detailParser = new xmlModule.XmlParser(onEventCallback3, onErrorCallback);
var LocationsService = /** @class */ (function () {
    function LocationsService() {
    }
    LocationsService.prototype.getServiceLocationsText = function (id) {
        return fetchModule.fetch('https://primary-health.net/ServiceDetail.aspx?id=' + id, {
            method: "GET"
        })
            .then(this.handleErrors)
            .then(function (x) {
            return x.text();
        })
            .then(function (x) {
            var token = '<!-- /.etabs -->';
            var result = x.split(token);
            //console.log(result.length)
            return result[1];
        });
    };
    LocationsService.prototype.getAllLocations = function () {
        return fetchModule.fetch('https://primary-health.net/Locations.aspx', {
            method: "GET"
        })
            .then(this.handleErrors)
            .then(function (x) {
            return x.text();
        })
            .then(function (x) {
            var counties = x.split('<article')[1]
                .split('id="Content_CountyList_CountyLabel_').splice(1);
            var results = [];
            counties.forEach(function (county) {
                var locations = county.split(/<ul style="list-style-type: none;">/gm).slice(1);
                var countyName = county.match(/>(.*?)</)[1];
                locations.forEach(function (location) {
                    var result = new location_1.Location();
                    var href = location.match(/href="(.*?)"/)[1];
                    var name = location.match(/itle="(.*?)"/)[1];
                    var phone = location.match(/PhoneLabel_.*?">(.*?)</)[1];
                    var address = location.match(/AddressLabel_.*?">(.*?)</)[1];
                    var image = location.match(/image_.*?">(.*?)</)[1];
                    var geo = location.match(/geoData_.*?">(.*?)</)[1];
                    result.push(href);
                    result.push(name);
                    result.push(phone);
                    result.push(address);
                    result.push(image);
                    result.push(geo);
                    result.push(countyName);
                    results.push(result);
                });
            });
            return results;
        });
    };
    LocationsService.prototype.getLocationDetails = function (id) {
        return fetchModule.fetch('https://primary-health.net/LocationDetail.aspx?id=' + id, {
            method: "GET"
        })
            .then(this.handleErrors)
            .then(function (x) {
            return x.text();
        })
            .then(function (x) {
            var geo = x.match(/<meta name="keywords" content="(.*?)"/)[1];
            var drs = x.split('org/Physician">').slice(1);
            var providers = [];
            currentDetail = new detail_1.LocationDetail();
            drs.forEach(function (dr) {
                var service = dr.match(/<h4><span>(.*)<\/span><\/h4>/)[1];
                var id = dr.match(/\?id=(.*)"/)[1];
                var name = dr.match(/itle="(.*?)" h/)[1];
                var provider = new provider_1.Provider(name);
                provider.setId(id);
                provider.setServiceName(service);
                providers.push(provider);
            });
            currentDetail.setProviders(providers);
            currentDetail.setGeo(geo);
            detailParser.parse('<html><div' +
                x.split('<div class="post format-image"')[1]);
            return currentDetail;
        });
    };
    LocationsService.prototype.getServiceProviders = function (id) {
        return fetchModule.fetch('https://primary-health.net/ServiceDetail.aspx?id=' + id, {
            method: "GET"
        })
            .then(this.handleErrors)
            .then(function (x) {
            return x.text();
        })
            .then(function (x) {
            var token = '<!-- /.etabs -->';
            var result = x.split(token);
            var drs = x.split('org/Physician">').slice(1);
            var providers = [];
            drs.forEach(function (dr) {
                var service = dr.split('span')[6].slice(1, -2);
                var id = dr.match(/\?id=(.*?)"/)[1];
                var name = dr.match(/itle="(.*?)" h/)[1];
                var provider = new provider_1.Provider(name);
                provider.setId(id);
                provider.setServiceName(service);
                providers.push(provider);
            });
            return providers;
        });
    };
    LocationsService.prototype.getCounties = function () {
        return fetchModule.fetch("https://primary-health.net", {
            method: "GET"
        })
            .then(this.handleErrors)
            .then(function (z) {
            return z.text();
        })
            .then(function (y) {
            currentCounties = [];
            //                currentCounties = x.split('Health Centers</a>')[1];
            countyParser.parse('<html>' + y.split('Health Centers</a>')[1]);
            currentCounties.pop();
             currentCounties.pop();
            return currentCounties;
        });
    };
    LocationsService.prototype.handleErrors = function (response) {
        if (!response.ok) {
            throw Error(response.statusText);
        }
        return response;
    };
    LocationsService = __decorate([
        core_1.Injectable(),
        __metadata("design:paramtypes", [])
    ], LocationsService);
    return LocationsService;
}());
exports.LocationsService = LocationsService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYXRpb25zLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJsb2NhdGlvbnMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHNDQUEyQztBQUUzQyxJQUFJLFdBQVcsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7QUFFbkMsZ0RBQWtEO0FBQ2xELHVDQUFzQztBQUN0QyxtQ0FBa0M7QUFDbEMsbUNBQTBDO0FBQzFDLGtEQUFnRDtBQUVoRCxJQUFJLGVBQWUsQ0FBQztBQUNwQixJQUFJLGdCQUFnQixDQUFDO0FBQ3JCLElBQUksZUFBZSxDQUFDO0FBQ3BCLElBQUksYUFBYSxDQUFDO0FBQ2xCLElBQUksYUFBNkIsQ0FBQztBQUVsQyxJQUFJLGdCQUFnQixHQUFHLFVBQVMsS0FBNEI7SUFDeEQsUUFBUSxLQUFLLENBQUMsU0FBUyxFQUFFO1FBRXJCLEtBQUssU0FBUyxDQUFDLGVBQWUsQ0FBQyxZQUFZO1lBRXZDLElBQUksS0FBSyxDQUFDLFdBQVcsS0FBSyxHQUFHO2dCQUN6QixNQUFNO1lBQ1YsYUFBYSxHQUFHLElBQUksZUFBTSxFQUFFLENBQUM7WUFDN0IsZUFBZSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztZQUNwQyxJQUFJLE9BQU8sR0FBRyxLQUFLLENBQUMsU0FBUyxHQUFHLEdBQUcsR0FBRyxLQUFLLENBQUMsV0FBVyxDQUFDO1lBQ3hELElBQUksS0FBSyxDQUFDLFVBQVUsRUFBRTtnQkFDbEIsT0FBTyxJQUFJLGVBQWUsQ0FBQztnQkFDM0IsS0FBSyxJQUFJLGFBQWEsSUFBSSxLQUFLLENBQUMsVUFBVSxFQUFFO29CQUN4QyxJQUFJLEtBQUssQ0FBQyxVQUFVLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxJQUFJLGFBQWEsS0FBSyxNQUFNLEVBQUU7d0JBQzVFLE9BQU8sSUFBSSxHQUFHLEdBQUcsYUFBYSxHQUFHLEtBQUssR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFDLGFBQWEs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cG9ydCB7IEluamVjdGFibGUgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuXG52YXIgZmV0Y2hNb2R1bGUgPSByZXF1aXJlKFwiZmV0Y2hcIik7XG5cbmltcG9ydCAqIGFzIHhtbE1vZHVsZSBmcm9tIFwidG5zLWNvcmUtbW9kdWxlcy94bWxcIjtcbmltcG9ydCB7IExvY2F0aW9uIH0gZnJvbSBcIi4vbG9jYXRpb25cIjtcbmltcG9ydCB7IENvdW50eSB9IGZyb20gXCIuL2NvdW50eVwiO1xuaW1wb3J0IHsgTG9jYXRpb25EZXRhaWwgfSBmcm9tIFwiLi9kZXRhaWxcIjtcbmltcG9ydCB7IFByb3ZpZGVyIH0gZnJvbSBcIi4uL3Byb3ZpZGVycy9wcm92aWRlclwiXG5cbnZhciBjdXJyZW50TG9jYXRpb247XG52YXIgY3VycmVudExvY2F0aW9ucztcbnZhciBjdXJyZW50Q291bnRpZXM7XG52YXIgY3VycmVudENvdW50eTtcbmxldCBjdXJyZW50RGV0YWlsOiBMb2NhdGlvbkRldGFpbDtcblxudmFyIG9uRXZlbnRDYWxsYmFjazIgPSBmdW5jdGlvbihldmVudDogeG1sTW9kdWxlLlBhcnNlckV2ZW50KSB7XG4gICAgc3dpdGNoIChldmVudC5ldmVudFR5cGUpIHtcblxuICAgICAgICBjYXNlIHhtbE1vZHVsZS5QYXJzZXJFdmVudFR5cGUuU3RhcnRFbGVtZW50OlxuXG4gICAgICAgICAgICBpZiAoZXZlbnQuZWxlbWVudE5hbWUgIT09ICdhJylcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGN1cnJlbnRDb3VudHkgPSBuZXcgQ291bnR5KCk7XG4gICAgICAgICAgICBjdXJyZW50Q291bnRpZXMucHVzaChjdXJyZW50Q291bnR5KTtcbiAgICAgICAgICAgIHZhciBtZXNzYWdlID0gZXZlbnQuZXZlbnRUeXBlICsgXCIgXCIgKyBldmVudC5lbGVtZW50TmFtZTtcbiAgICAgICAgICAgIGlmIChldmVudC5hdHRyaWJ1dGVzKSB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZSArPSBcIiwgQXR0cmlidXRlczpcIjtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBhdHRyaWJ1dGVOYW1lIGluIGV2ZW50LmF0dHJpYnV0ZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50LmF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkoYXR0cmlidXRlTmFtZSkgJiYgYXR0cmlidXRlTmFtZSA9PT0gJ2hyZWYnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlICs9IFwiIFwiICsgYXR0cmlidXRlTmFtZSArIFwiPVxcXCJcIiArIGV2ZW50LmF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV0gKyBcIlxcXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRDb3VudHkucHVzaChldmVudC5hdHRyaWJ1dGVzWydocmVmJ10pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhtZXNzYWdlKTtcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgeG1sTW9kdWxlLlBhcnNlckV2ZW50VHlwZS5FbmRFbGVtZW50OlxuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhldmVudC5ldmVudFR5cGUgKyBcIiBcIiArIGV2ZW50LmVsZW1lbnROYW1lKTtcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgeG1sTW9kdWxlLlBhcnNlckV2ZW50VHlwZS5UZXh0OlxuICAgICAgICAgICAgdmFyIHNpZ25pZmljYW50VGV4dCA9IGV2ZW50LmRhdGEudHJpbSgpO1xuICAgICAgICAgICAgaWYgKHNpZ25pZmljYW50VGV4dCAhPT0gXCJcIikge1xuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coZXZlbnQuZXZlbnRUeXBlICsgXCI9XFxcIlwiICsgc2lnbmlmaWNhbnRUZXh0ICsgXCJcXFwiXCIpO1xuICAgICAgICAgICAgICAgIC8vY3VycmVudENvdW50eS5wdXNoKHNpZ25pZmljYW50VGV4dCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBicmVhaztcbiAgICB9XG59O1xuXG52YXIgb25FdmVudENhbGxiYWNrMyA9IGZ1bmN0aW9uKGV2ZW50OiB4bWxNb2R1bGUuUGFyc2VyRXZlbnQpIHtcbiAgICBzd2l0Y2ggKGV2ZW50LmV2ZW50VHlwZSkge1xuXG4gICAgICAgIGNhc2UgeG1sTW9kdWxlLlBhcnNlckV2ZW50VHlwZS5TdGFydEVsZW1lbnQ6XG4gICAgICAgICAgICBpZiAoZXZlbnQuZWxlbWVudE5hbWUgPT09ICdpbWcnKSB7XG4gICAgICAgICAgICAgICAgY3VycmVudERldGFpbC5zZXRJbWFnZShldmVudC5hdHRyaWJ1dGVzWydzcmMnXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgbWVzc2FnZSA9IGV2ZW50LmV2ZW50VHlwZSArIFwiIFwiICsgZXZlbnQuZWxlbWVudE5hbWU7XG4gICAgICAgICAgICBpZiAoZXZlbnQuYXR0cmlidXRlcykge1xuICAgICAgICAgICAgICAgIG1lc3NhZ2UgKz0gXCIsIEF0dHJpYnV0ZXM6XCI7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgYXR0cmlidXRlTmFtZSBpbiBldmVudC5hdHRyaWJ1dGVzKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5hdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KGF0dHJpYnV0ZU5hbWUpICYmIGF0dHJpYnV0ZU5hbWUgPT09ICdocmVmJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSArPSBcIiBcIiArIGF0dHJpYnV0ZU5hbWUgKyBcIj1cXFwiXCIgKyBldmVudC5hdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdICsgXCJcXFwiXCI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvL2NvbnNvbGUubG9nKG1lc3NhZ2UpO1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSB4bWxNb2R1bGUuUGFyc2VyRXZlbnRUeXBlLkVuZEVsZW1lbnQ6XG4gICAgICAgICAgICAvLyAgICAgICAgICAgIGNvbnNvbGUubG9nKGV2ZW50LmV2ZW50VHlwZSArIFwiIFwiICsgZXZlbnQuZWxlbWVudE5hbWUpO1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSB4bWxNb2R1bGUuUGFyc2VyRXZlbnRUeXBlLlRleHQ6XG4gICAgICAgICAgICB2YXIgc2lnbmlmaWNhbnRUZXh0ID0gZXZlbnQuZGF0YS50cmltKCk7XG4gICAgICAgICAgICBpZiAoc2lnbmlmaWNhbnRUZXh0ICE9PSBcIlwiKSB7XG4gICAgICAgICAgICAgICAgLy8gICBjb25zb2xlLmxvZyhldmVudC5ldmVudFR5cGUgKyBcIj1cXFwiXCIgKyBzaWduaWZpY2FudFRleHQgKyBcIlxcXCJcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjdXJyZW50RGV0YWlsLnB1c2goc2lnbmlmaWNhbnRUZXh0KTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgIH1cbn07XG5cbnZhciBvbkVycm9yQ2FsbGJhY2sgPSBmdW5jdGlvbihlcnJvcjogRXJyb3IpIHtcbiAgICAvL2NvbnNvbGUubG9nKFwiRXJyb3I6IFwiICsgZXJyb3IubWVzc2FnZSk7XG59O1xuXG52YXIgY291bnR5UGFyc2VyID0gbmV3IHhtbE1vZHVsZS5YbWxQYXJzZXIob25FdmVudENhbGxiYWNrMiwgb25FcnJvckNhbGxiYWNrKTtcbnZhciBkZXRhaWxQYXJzZXIgPSBuZXcgeG1sTW9kdWxlLlhtbFBhcnNlcihvbkV2ZW50Q2FsbGJhY2szLCBvbkVycm9yQ2FsbGJhY2spO1xuXG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBMb2NhdGlvbnNTZXJ2aWNlIHtcbiAgICBjb25zdHJ1Y3RvcigpIHsgfVxuXG4gICAgZ2V0U2VydmljZUxvY2F0aW9uc1RleHQoaWQpIHtcbiAgICAgICAgcmV0dXJuIGZldGNoTW9kdWxlLmZldGNoKCdodHRwczovL3ByaW1hcnktaGVhbHRoLm5ldC9TZXJ2aWNlRGV0YWlsLmFzcHg/aWQ9JyArIGlkLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIG1ldGhvZDogXCJHRVRcIlxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC50aGVuKHRoaXMuaGFuZGxlRXJyb3JzKVxuICAgICAgICAgICAgLnRoZW4oKHgpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4geC50ZXh0KCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4oKHgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCB0b2tlbiA9ICc8IS0tIC8uZXRhYnMgLS0+J1xuICAgICAgICAgICAgICAgIGxldCByZXN1bHQgPSB4LnNwbGl0KHRva2VuKTtcblxuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2cocmVzdWx0Lmxlbmd0aClcblxuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRbMV07XG4gICAgICAgICAgICB9KVxuICAgIH1cblxuICAgIGdldEFsbExvY2F0aW9ucygpIHtcbiAgICAgICAgcmV0dXJuIGZldGNoTW9kdWxlLmZldGNoKCdodHRwczovL3ByaW1hcnktaGVhbHRoLm5ldC9Mb2NhdGlvbnMuYXNweCcsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbWV0aG9kOiBcIkdFVFwiXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4odGhpcy5oYW5kbGVFcnJvcnMpXG4gICAgICAgICAgICAudGhlbigoeCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB4LnRleHQoKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAudGhlbigoeCkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBjb3VudGllcyA9IHguc3BsaXQoJzxhcnRpY2xlJylbMV1cbiAgICAgICAgICAgICAgICAgICAgLnNwbGl0KCdpZD1cIkNvbnRlbnRfQ291bnR5TGlzdF9Db3VudHlMYWJlbF8nKS5zcGxpY2UoMSk7XG4gICAgICAgICAgICAgICAgbGV0IHJlc3VsdHMgPSBbXTtcblxuICAgICAgICAgICAgICAgIGNvdW50aWVzLmZvckVhY2goKGNvdW50eSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBsZXQgbG9jYXRpb25zID0gY291bnR5LnNwbGl0KFxuICAgICAgICAgICAgICAgICAgICAgICAgLzx1bCBzdHlsZT1cImxpc3Qtc3R5bGUtdHlwZTogbm9uZTtcIj4vZ20pLnNsaWNlKDEpO1xuICAgICAgICAgICAgICAgICAgICBsZXQgY291bnR5TmFtZSA9IGNvdW50eS5tYXRjaCgvPiguKj8pPC8pWzFdO1xuXG4gICAgICAgICAgICAgICAgICAgIGxvY2F0aW9ucy5mb3JFYWNoKChsb2NhdGlvbikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJlc3VsdCA9IG5ldyBMb2NhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGhyZWYgPSBsb2NhdGlvbi5tYXRjaCgvaHJlZj1cIiguKj8pXCIvKVsxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBuYW1lID0gbG9jYXRpb24ubWF0Y2goL2l0bGU9XCIoLio/KVwiLylbMV07XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGhvbmUgPSBsb2NhdGlvbi5tYXRjaCgvUGhvbmVMYWJlbF8uKj9cIj4oLio/KTwvKVsxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhZGRyZXNzID0gbG9jYXRpb24ubWF0Y2goL0FkZHJlc3NMYWJlbF8uKj9cIj4oLio/KTwvKVsxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpbWFnZSA9IGxvY2F0aW9uLm1hdGNoKC9pbWFnZV8uKj9cIj4oLio/KTwvKVsxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBnZW8gPSBsb2NhdGlvbi5tYXRjaCgvZ2VvRGF0YV8uKj9cIj4oLio/KTwvKVsxXTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goaHJlZilcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG5hbWUpXG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChwaG9uZSlcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGFkZHJlc3MpXG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChpbWFnZSlcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGdlbylcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGNvdW50eU5hbWUpXG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2gocmVzdWx0KTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRzO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2V0TG9jYXRpb25EZXRhaWxzKGlkKSB7XG4gICAgICAgIHJldHVybiBmZXRjaE1vZHVsZS5mZXRjaCgnaHR0cHM6Ly9wcmltYXJ5LWhlYWx0aC5uZXQvTG9jYXRpb25EZXRhaWwuYXNweD9pZD0nICsgaWQsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbWV0aG9kOiBcIkdFVFwiXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4odGhpcy5oYW5kbGVFcnJvcnMpXG4gICAgICAgICAgICAudGhlbigoeCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB4LnRleHQoKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAudGhlbigoeCkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBnZW8gPSB4Lm1hdGNoKC88bWV0YSBuYW1lPVwia2V5d29yZHNcIiBjb250ZW50PVwiKC4qPylcIi8pWzFdO1xuICAgICAgICAgICAgICAgIGxldCBkcnMgPSB4LnNwbGl0KCdvcmcvUGh5c2ljaWFuXCI+Jykuc2xpY2UoMSlcbiAgICAgICAgICAgICAgICBsZXQgcHJvdmlkZXJzOiBBcnJheTxQcm92aWRlcj4gPSBbXTtcblxuICAgICAgICAgICAgICAgIGN1cnJlbnREZXRhaWwgPSBuZXcgTG9jYXRpb25EZXRhaWwoKTtcbiAgICAgICAgICAgICAgICBkcnMuZm9yRWFjaCgoZHIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHNlcnZpY2UgPSBkci5tYXRjaCgvPGg0PjxzcGFuPiguKik8XFwvc3Bhbj48XFwvaDQ+LylbMV07XG4gICAgICAgICAgICAgICAgICAgIGxldCBpZCA9IGRyLm1hdGNoKC9cXD9pZD0oLiopXCIvKVsxXVxuICAgICAgICAgICAgICAgICAgICBsZXQgbmFtZSA9IGRyLm1hdGNoKC9pdGxlPVwiKC4qPylcIiBoLylbMV1cbiAgICAgICAgICAgICAgICAgICAgbGV0IHByb3ZpZGVyID0gbmV3IFByb3ZpZGVyKG5hbWUpO1xuXG4gICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyLnNldElkKGlkKVxuICAgICAgICAgICAgICAgICAgICBwcm92aWRlci5zZXRTZXJ2aWNlTmFtZShzZXJ2aWNlKVxuICAgICAgICAgICAgICAgICAgICBwcm92aWRlcnMucHVzaChwcm92aWRlcilcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIGN1cnJlbnREZXRhaWwuc2V0UHJvdmlkZXJzKHByb3ZpZGVycyk7XG4gICAgICAgICAgICAgICAgY3VycmVudERldGFpbC5zZXRHZW8oZ2VvKTtcbiAgICAgICAgICAgICAgICBkZXRhaWxQYXJzZXIucGFyc2UoXG4gICAgICAgICAgICAgICAgICAgICc8aHRtbD48ZGl2JyArXG4gICAgICAgICAgICAgICAgICAgIHguc3BsaXQoJzxkaXYgY2xhc3M9XCJwb3N0IGZvcm1hdC1pbWFnZVwiJylbMV0pO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnREZXRhaWw7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBnZXRTZXJ2aWNlUHJvdmlkZXJzKGlkKSB7XG4gICAgICAgIHJldHVybiBmZXRjaE1vZHVsZS5mZXRjaCgnaHR0cHM6Ly9wcmltYXJ5LWhlYWx0aC5uZXQvU2VydmljZURldGFpbC5hc3B4P2lkPScgKyBpZCxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBtZXRob2Q6IFwiR0VUXCJcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAudGhlbih0aGlzLmhhbmRsZUVycm9ycylcbiAgICAgICAgICAgIC50aGVuKCh4KSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHgudGV4dCgpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC50aGVuKCh4KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgdG9rZW4gPSAnPCEtLSAvLmV0YWJzIC0tPidcbiAgICAgICAgICAgICAgICBsZXQgcmVzdWx0ID0geC5zcGxpdCh0b2tlbik7XG4gICAgICAgICAgICAgICAgbGV0IGRycyA9IHguc3BsaXQoJ29yZy9QaHlzaWNpYW5cIj4nKS5zbGljZSgxKVxuICAgICAgICAgICAgICAgIGxldCBwcm92aWRlcnM6IEFycmF5PFByb3ZpZGVyPiA9IFtdO1xuXG4gICAgICAgICAgICAgICAgZHJzLmZvckVhY2goKGRyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBzZXJ2aWNlID0gZHIuc3BsaXQoJ3NwYW4nKVs2XS5zbGljZSgxLCAtMilcbiAgICAgICAgICAgICAgICAgICAgbGV0IGlkID0gZHIubWF0Y2goL1xcP2lkPSguKj8pXCIvKVsxXVxuICAgICAgICAgICAgICAgICAgICBsZXQgbmFtZSA9IGRyLm1hdGNoKC9pdGxlPVwiKC4qPylcIiBoLylbMV1cbiAgICAgICAgICAgICAgICAgICAgbGV0IHByb3ZpZGVyID0gbmV3IFByb3ZpZGVyKG5hbWUpO1xuXG4gICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyLnNldElkKGlkKVxuICAgICAgICAgICAgICAgICAgICBwcm92aWRlci5zZXRTZXJ2aWNlTmFtZShzZXJ2aWNlKVxuICAgICAgICAgICAgICAgICAgICBwcm92aWRlcnMucHVzaChwcm92aWRlcilcbiAgICAgICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHByb3ZpZGVycztcbiAgICAgICAgICAgIH0pXG5cbiAgICB9XG5cbiAgICBnZXRDb3VudGllcygpIHtcbiAgICAgICAgcmV0dXJuIGZldGNoTW9kdWxlLmZldGNoKFwiaHR0cHM6Ly9wcmltYXJ5LWhlYWx0aC5uZXRcIixcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBtZXRob2Q6IFwiR0VUXCJcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAudGhlbih0aGlzLmhhbmRsZUVycm9ycylcbiAgICAgICAgICAgIC50aGVuKCh6KSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHoudGV4dCgpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC50aGVuKCh5KSA9PiB7XG4gICAgICAgICAgICAgICAgY3VycmVudENvdW50aWVzID0gW107XG5cbiAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgICAgICBjdXJyZW50Q291bnRpZXMgPSB4LnNwbGl0KCdIZWFsdGggQ2VudGVyczwvYT4nKVsxXTtcbiAgICAgICAgICAgICAgICBjb3VudHlQYXJzZXIucGFyc2UoJzxodG1sPicgKyB5LnNwbGl0KCdIZWFsdGggQ2VudGVyczwvYT4nKVsxXSk7XG4gICAgICAgICAgICAgICAgY3VycmVudENvdW50aWVzLnBvcCgpO1xuICAgICAgICAgICAgICAgIGN1cnJlbnRDb3VudGllcy5wb3AoKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudENvdW50aWVzO1xuICAgICAgICAgICAgfSk7XG5cbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZUVycm9ycyhyZXNwb25zZSkge1xuICAgICAgICBpZiAoIXJlc3BvbnNlLm9rKSB7XG4gICAgICAgICAgICB0aHJvdyBFcnJvcihyZXNwb25zZS5zdGF0dXNUZXh0KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgfVxufVxuIl19
